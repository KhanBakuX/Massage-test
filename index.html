<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Массажисты на карте</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #app {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #f5f5f5;
      }

      #map {
        flex: 1 1 auto;
      }

      #panel {
        flex: 0 0 auto;
        padding: 12px 16px;
        border-top: 1px solid #ddd;
        background: #ffffff;
        display: none;
        position: relative;
      }

      #panel h2 {
        margin: 0 0 4px;
        font-size: 16px;
      }

      #panel p {
        margin: 2px 0;
        font-size: 14px;
      }

      /* Кастомный кластер (кружок с количеством) */
      .custom-cluster {
        background: #ffffff;
        border-radius: 50%;
        border: 3px solid #0052cc;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        color: #0052cc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 13px;
      }

      .custom-cluster div {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Кастомный маркер с фото и ценой */
      .custom-marker {
        position: relative;
        width: 54px;
        height: 70px;
        transform: translate(-27px, -70px);
      }

      .custom-marker .marker-photo {
        width: 54px;
        height: 60px;
        border-radius: 10px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }

      .custom-marker .marker-price {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        padding: 2px 4px;
        background: rgba(0, 0, 0, 0.7);
        color: #ffffff;
        font-size: 11px;
        text-align: center;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="map"></div>
      <div id="panel">
        <h2 id="t-name"></h2>
        <p id="t-district"></p>
        <p id="t-price"></p>
        <p id="t-desc"></p>
        <p id="t-contact"></p>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      const map = L.map("map").setView([55.7558, 37.6176], 11);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>',
      }).addTo(map);

      // Группа кластеров: кружок с количеством, который распадается при увеличении масштаба
      const clusterGroup = L.markerClusterGroup({
        iconCreateFunction(cluster) {
          const count = cluster.getChildCount();
          return L.divIcon({
            html: `<div>${count}</div>`,
            className: "custom-cluster",
            iconSize: [44, 44],
          });
        },
      });

      function showPanel(t) {
        document.getElementById("t-name").textContent = t.name;
        document.getElementById(
          "t-district"
        ).textContent = `Район: ${t.district}`;
        document.getElementById(
          "t-price"
        ).textContent = `Цена от: ${t.price_from} ₽`;
        document.getElementById(
          "t-desc"
        ).textContent = `Описание: ${t.short_description}`;
        document.getElementById(
          "t-contact"
        ).textContent = `Telegram: @${t.telegram_username}  ${
          t.phone ? " | Телефон: " + t.phone : ""
        }`;

        document.getElementById("panel").style.display = "block";
      }

      function hidePanel() {
        document.getElementById("panel").style.display = "none";
      }

      // Закрытие панели при клике на карту
      map.on("click", () => {
        hidePanel();
      });

      // Загрузка массажистов из API
      async function loadTherapists() {
        try {
          // API через ngrok (публичный доступ)
          const apiUrl = "https://retroflex-eupneic-rosamond.ngrok-free.dev/api/therapists";

          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error("Не удалось загрузить данные");
          }
          const therapists = await response.json();

          therapists.forEach((t) => {
            if (!t.lat || !t.lon) return;
            
            const markerIcon = L.divIcon({
              className: "custom-marker",
              html: `
                <div class="marker-photo" style="background-image:url('${
                  t.photo_url ||
                  "https://images.pexels.com/photos/3738341/pexels-photo-3738341.jpeg?auto=compress&cs=tinysrgb&w=200"
                }')"></div>
                <div class="marker-price">${t.price_from.toLocaleString(
                  "ru-RU"
                )} ₽</div>
              `,
              iconSize: [54, 70],
              iconAnchor: [27, 70],
            });

            const marker = L.marker([t.lat, t.lon], { icon: markerIcon });
            
            // При клике на маркер показываем анкету
            // Клик по маркеру НЕ всплывает до карты, поэтому панель не закроется
            marker.on("click", (e) => {
              L.DomEvent.stopPropagation(e); // Останавливаем всплытие события
              showPanel(t);
            });
            
            clusterGroup.addLayer(marker);
          });

          map.addLayer(clusterGroup);

        } catch (error) {
          console.error("Ошибка при загрузке массажистов:", error);
          // Если API недоступен, можно показать сообщение или использовать fallback
          alert("Не удалось загрузить данные массажистов. Проверьте, что бот запущен на localhost:8080");
        }
      }

      // Запускаем загрузку при открытии страницы
      loadTherapists();
    </script>
  </body>
  </html>

